% -*- coding: iso-2022-jp; mode: japanese-latex -*-
% Tokyo Debian Meeting resources
% Copyright (C) 2011 Junichi Uekawa
% Copyright (C) 2011 Nobuhiro Iwamatsu
% Copyright (C) 2013 Youhei SASAKI
%
% This program is free software; you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation; either version 2 of the License, or
% (at your option) any later version.
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program; if not, write to the Free Software
% Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
%
%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
% (shell-command "cd images; ebb *.png")
%
%% ここからヘッダ開始。%
\documentclass[a4paper]{jsarticle}
\usepackage{gum2013}

\begin{document}

\dancersection{gdb+python拡張を使ったデバッグ手法}{野島 貴英}
\label{sec:gdb-python-php}

 debian付属のgdbはすでにpython拡張が有効になっている状態でパッケージ化されています。
今回の発表では、debianに用意されている機能をフル活用して、php5のソースデバッグを
gdb+pythonをつかってやってみる事について述べます。

\subsection{今回発表のdebian環境について}

 今回発表のdebian環境は特に断りがない限り、debian sid環境となります。
表\ref{tab:debian-sid-version}に本発表で利用したdebian sid環境に含まれる
主なソフトウェアのバージョンを記載します。

\begin{table}[hb!]
  \centering
  \begin{tabular}{l|l|l|l}
    \hline
    項番1 & コマンド名 & バージョン & 備考 \\ \hline
    1 & gdb & 7.6 & \\
    2 & php & 5.5.0RC3 & \\
    3 & apache & 2.4.4 & \\
    \hline
  \end{tabular}
  \caption{今回発表のdebian sid環境でのソフトウェアのバージョン}
  \label{tab:debian-sid-version}
\end{table}

\subsection{gdb+python拡張今までのおさらい}

 　gdbは、バイナリ形式の実行ファイルをデバッグするのに、極めて強力な
シンボリックデバッガです。

　gdbのアップストリームはGNU Project\footnote{\url{http://www.gnu.org/}}であり、gccとならんで、プログラム開発には欠かせないツールとなります。

　ここでデバッガをスクリプトから操れると、より効率的なデバッグが可能になります。
gdbは古くから、gdbコマンドと簡単な制御構文を記載したスクリプトファイルを
用意すれば強力なデバッグが可能です。例えば、apacheのソースコードには、以前から
apache用のgdbによるデバッグのために.gdbinitスクリプトが付属しており、
中を見ていただければ分かるとおり、apacheの内部変数を便利に参照するための
コマンドが実装されています。

　ここで、gdbはversion 7.0から、pythonを内臓してpythonスクリプトからgdbを操る事が
できるようになりました。これでより一層、強力かつ柔軟なデバッグが可能になります。
debianではsqueezeの時からデフォルトでpythonスクリプトが使えるようになっています。

　東京エリアdebian勉強会の3月\footnote{\url{http://tokyodebian.alioth.debian.org/2013-03.html}に掲載の勉強会資料掲載}では、gdb v7.4(wheezy搭載のgdb)を用いて、

  \begin{itemize}
    \item gdb+python拡張機能の内部構造
    \item gdbクラスのclass図(gdb v7.4用)
    \item gdb.Commandクラス、gdb.BreakPointクラス、gdb.FinishPointクラス
    \item python拡張機能を実際に使ってデバッグシンボル付きのCプログラムの関数の実行トレースをする
　\end{itemize}

の発表を行いました。

 今回は東京エリアdebian勉強会の2013年3月の内容を発展させて、
 \begin{itemize}
   \item debianの*-dbgパッケージを使い、
   \item php5のphpソースコードレベルデバッグをしてみる
 \end{itemize}
事について述べます。

\subsection{debianの*-dbgパッケージ}

 debianには、バイナリパッケージのデバッグ用シンボル情報だけを集めた
*-dbgパッケージ群が提供されています。

 利用の仕方は簡単で、デバッグしたいバイナリパッケージの名前に-dbgと付いた
パッケージを導入し、gdbを動かすだけです。

\begin{commandline}
# ↓　*-dbgパッケージの一覧を見てみる
% aptitude search '.*-dbg' 
p   0ad-dbg                         - Real-time strategy game of ancient warfare
p   389-ds-base-dbg                 - 389 Directory Server suite - server debugg
p   389-ds-base-libs-dbg            - 389 Directory Server suite - library debug
p   7kaa-dbg                        - Seven Kingdoms Ancient Adversaries - debug
...中略...
# ↓  試しに php5のデバッグのために、php5-dbgを導入してみる。
% sudo aptitude install 'php5-dbg'
# ↓ ソースコードもカレントディレクトリに展開してみる。
% apt-get source php5
# ↓ /usr/bin/php5について使ってみる
% gdb --args /usr/bin/php5 -r 'phpinfo();'
(gdb) !ls (← ソースコードの導入状況を確認してみる)
php5-5.5.0~rc3+dfsg		     php5_5.5.0~rc3+dfsg-1.dsc
php5_5.5.0~rc3+dfsg-1.debian.tar.gz  php5_5.5.0~rc3+dfsg.orig.tar.xz
(gdb) !pwd (← ソースコードの導入場所の確認)
/home/xxxx/src/php5/
(gdb) b main
Breakpoint 1 at 0x4640a0: file /tmp/buildd/php5-5.5.0~rc3+dfsg/sapi/cli/php_cli.c, line 1200.
(gdb) set substitute-path /tmp/buildd/ /home/xxxx/src/php5/ (←ソースコードの位置の指定)
(gdb) run
Starting program: /usr/bin/php5 -r phpinfo\(\)\;
...中略...
Breakpoint 1, main (argc=3, argv=0x7fffffffe668)
    at /tmp/buildd/php5-5.5.0~rc3+dfsg/sapi/cli/php_cli.c:1200
1200	{
(gdb) l (←現在実行中のソースコードを閲覧)
1195	#ifdef PHP_CLI_WIN32_NO_CONSOLE
1196	int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nShowCmd)
1197	#else
1198	int main(int argc, char *argv[])
1199	#endif
1200	{
1201	#ifdef ZTS
...中略...

\end{commandline}

（なお、上の例ではソースコード指定に''set substitution-path''を利用しましたが、
必ずしもこれでうまく行くわけではないことを後に述べます。）

\subsection{*-dbgパッケージについてちょっとだけ}

 *-dbgパッケージに関しての現状と詳細は2012年の大統一Debian勉強会の岩松さんの発表「debug.debian.net」\footnote{\url{http://gum.debian.or.jp/2012/}に掲載されています}に詳しいため、ここでは、そこで触れられていなかった件をいくつか載せておきます。

\subsubsection{ソースコードのパスの指定について}

 *-dbgパッケージを利用してgdbからソースコードを指定するための指定方法は、
以下の２種類の方法を適宜選んで指定します。

 \begin{itemize} 
   \item gdbの''set substitute-path''で指定する方法\\
 これは、パッケージがビルドされる際、gccに対してソースがフルパスで指定されているときに使える方法となります。先ほどのphp5の例のように、一つの''set substitute-path''を指定するだけで、upstream側のソースのサブディレクトリに配置されているソースコードも自動でgdbが追跡してくれますので、デバッグ時のソース閲覧に非常に都合が良いです。
   \item gdbの''dir''でソースの位置を複数指定する方法\\
 これは、パッケージがビルドされる際、gccに対してファイル名のみ指定されてコンパイルされている場合に使います。こちらの場合、*-dbgパッケージのシンボルにソースのパスを示す情報が欠落している為、ソースの位置は''dir''コマンドでヒントとして指定することになります。gdbはユーザが''dir''コマンドで指定したソースの存在するパス全部を記憶しており、このパスに同名のファイルがあるかを調べ、最初に合致したものを表示します。つまり、完全に同名のファイルが複数のサブディレクトリに配置されていたものをビルド及びリンクした場合は、gdbは自動では正しいソースファイル上での位置を表示できない為、注意が必要です。
\end{itemize}

\subsubsection{COMPATIBILITY LEVEL 9から搭載されたデバッグシンボルファイルの形式について}

　パッケージ構築の際、debhelperのCOMPATIBILITY LEVEL 9から、導入されたデバッグシンボルファイルのファイル名は、パッケージの実行ファイルのバイナリに埋め込まれているハッシュ値を元につけられています。

　この為、バージョンがわずかに異なったパッケージでも、正確に対応した*-dbgパッケージが利用されるため、COMPATIBILITY LEVEL 9未満の形式の元に作成された*-dbgパッケージのように
うっかりシンボルファイルとバイナリ本体のバージョンが合わずにデバッグが意図せず困難になるという事故を防ぐ事ができるようになりました。

　wheezyはまだ、

図 \ref{fig:image01} として画像を入れる場合。
\begin{figure}[ht!]
  \begin{center}
    \includegraphics[width=.5\hsize]{images/openlogo-nd.eps}
  \end{center}
  \caption{キャプション}
  \label{fig:image01}
\end{figure}

\begin{enumerate}
\item 番号付きリスト1
\item 番号付きリスト2
\end{enumerate}


\begin{description}
\item[定義1] 定義文1
\item[定義2] 定義文2
\end{description}


\end{document}
