% -*- coding: iso-2022-jp; mode: japanese-latex -*-
% Tokyo Debian Meeting resources
% Copyright (C) 2011 Junichi Uekawa
% Copyright (C) 2011 Nobuhiro Iwamatsu
% Copyright (C) 2013 Youhei SASAKI
%
% This program is free software; you can redistribute it and/or modify
% it under the terms of the GNU General Public License as published by
% the Free Software Foundation; either version 2 of the License, or
% (at your option) any later version.
%
% This program is distributed in the hope that it will be useful,
% but WITHOUT ANY WARRANTY; without even the implied warranty of
% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
% GNU General Public License for more details.
%
% You should have received a copy of the GNU General Public License
% along with this program; if not, write to the Free Software
% Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301 USA
%
%  preview (shell-command (concat "evince " (replace-regexp-in-string "tex$" "pdf"(buffer-file-name)) "&"))
% 画像ファイルを処理するためにはebbを利用してboundingboxを作成。
% (shell-command "cd images; ebb *.png")
%
%% ここからヘッダ開始。%
\documentclass[a4paper]{jsarticle}
\usepackage{gum2013-sid}

\begin{document}

\dancersection{gdb+python拡張を使ったデバッグ手法}{野島 貴英}
\label{sec:gdb-python-php}

 debian付属のgdbはすでにpython拡張が有効になっている状態でパッケージ化されています。
今回の発表では、debianに用意されている機能をフル活用して、php5のphp言語レベルの
ソースデバッグをgdb+pythonをつかってやってみる事について述べます。

 なお、ここでは、debian sid(jessie/sid)を用い、パッケージから導入したgdb 7.6,php 5.5.0rc3を利用しています。

\subsection{gdb+python拡張今までのおさらい}

 　gdbは、バイナリ形式の実行ファイルをデバッグするのに、極めて強力な
シンボリックデバッガです。gdbはpythonを内臓することにより、さらに強力なデバッグが可能になっています。debianではsqueezeから有効になっています。

　東京エリアdebian勉強会の2013年3月にては、gdb+python拡張に搭載されているgdb.Command/ gdb.Breakpoint/ gdb.FinishBreakpointを使い、C言語による実行ファイルの関数トレースを取るところまで紹介しました。\cite{tokyo-debian-march}

\subsection{debianの*-dbgパッケージについてちょっとだけ}

 debianには、バイナリパッケージのデバッグ用シンボル情報だけを集めた
*-dbgパッケージ群が提供されています。

 利用の仕方は簡単で、デバッグしたいバイナリパッケージの名前に-dbgと付いた
パッケージを導入し、gdbを動かすだけです。

\begin{commandline}
% sudo aptitude install 'php5-dbg'
% apt-get source php5
% gdb --args /usr/bin/php5 -r 'phpinfo();'
...中略...
(gdb) b main
Breakpoint 1 at 0x4640a0: file /tmp/buildd/php5-5.5.0~rc3+dfsg/sapi/cli/php_cli.c, line 1200.
(gdb) set substitute-path /tmp/buildd/ ./
(gdb) run
Starting program: /usr/bin/php5 -r phpinfo\(\)\;
...中略...
Breakpoint 1, main (argc=3, argv=0x7fffffffe668)
    at /tmp/buildd/php5-5.5.0~rc3+dfsg/sapi/cli/php_cli.c:1200
1200	{
(gdb) l (←現在実行中のソースコードを閲覧)
1195	#ifdef PHP_CLI_WIN32_NO_CONSOLE
1196	int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nShowCmd)
1197	#else
1198	int main(int argc, char *argv[])
1199	#endif
1200	{
1201	#ifdef ZTS
...中略...
\end{commandline}

（なお、上の例ではソースコード指定に''set substitution-path''を利用しましたが、
現状では必ずしもこれでうまく行くものばかりではない事を後に述べます。）

 なお、*-dbgパッケージに関しての現状と詳細は2012年の大統一Debian勉強会の岩松さんの発表「debug.debian.net」\cite{debug-debian-net}に詳しいです。ここでは、そこで触れられていなかった件をいくつか載せておきます。

\subsubsection{ソースコードのパスの指定について}

 *-dbgパッケージを利用してgdbからソースコードを指定するための指定方法は、
以下の２種類の方法を適宜選んで指定します。

 \begin{itemize} 
   \item gdbの''set substitute-path''で指定する方法\\
 これは、パッケージがビルドされる際、gccに対してソースがフルパスで指定されているときに使える方法となります。先ほどのphp5の例のように、一つの''set substitute-path''を指定するだけで、ソースのサブディレクトリに配置されているソースコードも正確に自動でgdbが追跡してくれますので、デバッグ時のソース閲覧に大変都合が良いです。
   \item gdbの''dir''でソースの位置を複数指定する方法\\
 これは、パッケージがビルドされる際、gccに対してファイル名のみ指定されてコンパイルされている場合に使います。こちらの場合、*-dbgパッケージのシンボルにソースのパスを示す情報が欠落している為、ソースの位置は''dir''コマンドでヒントとして指定することになります。gdbはユーザが''dir''コマンドで指定したソースの存在するパス全部を記憶しており、このパスに同名のファイルがあるかを調べ、最初に合致したものを表示します。つまり、完全に同名のファイルが複数のサブディレクトリに配置されていたものをビルド及びリンクした場合は、gdbは自動では正しいソースファイル上での位置を表示できない為、注意が必要です。
\end{itemize}

\subsubsection{debhelperのCOMPATIBILITY LEVEL 9から搭載されたデバッグシンボルファイルの形式について}

　パッケージ構築の際、debhelperのCOMPATIBILITY LEVEL 9から、導入されたデバッグ用シンボルファイルのファイル名は、パッケージの実行ファイルのバイナリに埋め込まれているBuildID
\cite{build-id-desc}というハッシュ値を元につけられています。以前の形式では、実行バイナリの名前がそのままデバッグ用シンボルファイルとなっていました。

\begin{commandline}
#↓ COMPATIBILITY LEVEL 9形式の場合
$ file /usr/lib/x86_64-linux-gnu/libgstreamer-0.10.so.0.30.0
/usr/lib/x86_64-linux-gnu/libgstreamer-0.10.so.0.30.0: ELF 64-bit LSB  
shared object, x86-64, version 1 (SYSV), dynamically linked, 
BuildID[sha1]=44ff321f11ffd750f8c351ffa3f5d20028d2f6a6, stripped 
# 表示されたBuildIDの、上２桁及び残りの桁をもちいて
# /usr/lib/debug/.build-id/上2桁/残りの桁.debugとなるファイルが
#デバッグ用シンボルファイルとなる。
$ ls /usr/lib/debug/.build-id/44/ff321f11ffd750f8c351ffa3f5d20028d2f6a6.debug
/usr/lib/debug/.build-id/44/ff321f11ffd750f8c351ffa3f5d20028d2f6a6.debug
# 試しにCOMPATIBILITY LEVEL 9形式で作成されたバイナリをgdbでロードしてみる
# gdb起動メッセージに含まれるReading symbols from 以下のファイル名のとおり、
# BuildIDで決まるシンボルファイルを読みにいく。
$ gdb /usr/lib/x86_64-linux-gnu/libgstreamer-0.10.so.0.30.0
GNU gdb (GDB) 7.6-debian
...中略...
Reading symbols from /usr/lib/x86_64-linux-gnu/libgstreamer-0.10.so.0.30.0...
Reading symbols from /usr/lib/debug/.build-id/44/ff321f11ffd750f8c351ffa3f5
d20028d2f6a6.debug...done.
(gdb) quit
#↓ COMPATIBILITY LEVEL 9形式未満の場合
# シンボルファイルは"/usr/lib/debug/"+"デバッグ対象の実行ファイルの絶対パス名"に格納
$ ls -l /usr/lib/debug/usr/bin/php5
-rw-r--r-- 1 root root 22036903  6月  2 01:44 /usr/lib/debug/usr/bin/php5
\end{commandline}

　gdbのようなデバッグ用シンボルファイルを扱うソフトウェアとしては、バイナリのBuildIDさえ分かれば、正しいデバッグ用シンボルファイルをすぐに特定できるので都合がよかったりします。従来のように同じファイル名のデバッグ用シンボルファイルを用意するという方法の場合、正しいデバッグ用シンボルファイルであることを保証するには、わざわざシンボルファイルのチェックサムを取って確認するぐらいしかありませんでした。\cite{build-id-desc}

　現在のdebian sidではCOMPATIBILITY LEVELは様々なLEVELのものが混在している状況の為、他のバイナリパッケージでは従来の/usr/lib/debug/"+"デバッグ対象の実行ファイルの絶対パス名"も未だ多数存在しています。

\subsection{php5.5のphpレベルのソースデバッグしてみる}

 php5系のphpレベルでのソースデバッグは、すでにかなり強力なものが存在しており、例えば
xdebugモジュールを利用し、vim-nox+debugger plugin/netbean/eclipse等の
DBGpをサポートできるエディタプラグイン/統合環境を使うことにより、簡単で、かなり強力な
デバッグ環境を使う事ができます。しかしながら、ここでは、それでは困るような
状況で、どうしてもgdbからphp5のphpのソースコードデバッグをせざるを得ない
\footnote{例：うっかりphp5でDaemon作ったら不具合出ちゃったので、なんとかgdbにて動いているプロセスにattachしてphp5ソースデバッグしたいとか、あるいは、phpプログラムの特定の場所でphp5がSEGVするのを検証したい(笑)とか....}時にどうするかを検討してみます。

\subsubsection{gdb.Valueクラス}

 gdbを使ってphp5で実行中のphpのソース上の情報を知る必要があるため、php5の内部変数にアクセスする必要があります。gdbのpython拡張ではこういうときに便利なgdb.Valueクラスが用意されています。gdb.Valueクラスは、gdbがアクセスできる変数をそのまま保持でき、様々な参照ができる能力があります。

\begin{commandline}
$gdb --args /usr/bin/php5 ./foo.php
...中略...
(gdb) set substitute-path /tmp/buildd/ /home/yours/php5-src/
(gdb) b zend_vm_execute.h:356
(gdb) run
(gdb) c 
Breakpoint 1, execute_ex (execute_data=0x7ffff7e2b0a0)
    at /tmp/buildd/php5-5.5.0~rc3+dfsg/Zend/zend_vm_execute.h:356
356			if ((ret = OPLINE->handler(execute_data TSRMLS_CC)) > 0) {
(gdb) p executor_globals.current_execute_data
$1 = (struct _zend_execute_data *) 0x7ffff7e2b0a0
(gdb) p executor_globals.current_execute_data->function_state->function->op_array->filename
$1 = 0x7ffff7e5f8d8 "/home/yours/foo.php" (←現在実行中のphpソースファイル名）
(gdb) pi (←gdb搭載のpythonをインタラクティブモードにする)
>>> edata=gdb.parse_and_eval("executor_globals.current_execute_data")
>>> print edata['function_state']['function']['op_array']['filename']
0x7ffff7e5f8d8 "/home/nojima/prog/my-works/php5-dbg/test4.php"
\end{commandline}
%$

 こちらの例では、php5.5の内部変数である、executor\_globals.current\_execute\_dataという構造体から、edataというgdb.Valueオブジェクトをgdb.parse\_and\_eval()を使って生成し、gdb.Valueオブジェクトのdereference()メソッドの能力を用いて一気にポインタを辿って値を取り出してみました。

 他にgdb.Valueクラスですが、こちらに関数へのポインタを代入すると、python側からphp5.5の
内部関数を呼び出したりもできます。（次の章にて使っています。）

\subsubsection{応用}

 以上を応用して、php5.5のgdb+pythonの組み合わせでphpソースファイルの
実行トレースを取ってみます。

　なお、今回のスクリプトの実行結果は、

\begin{commandline}
表示フォーマット:
"関数スコープ名" in 実行中のファイル名:実行中の行番号
例；
main関数中の/home/yours/test.phpファイルの4行目を実行中の場合は、
"main" in /home/yours/test.php:4
と表示。
\end{commandline}

となります。

\begin{commandline}
------php5.5-gdb.pyここから-----------------
# -*- coding: utf-8 -*-

class _Php5ExecuterHook(gdb.Breakpoint):
    """ peeking execution """
    def __init__(self,spec):
        super(_Php5ExecuterHook, self).__init__(spec,
                                               gdb.BP_BREAKPOINT,
                                               internal=False)
        self._phpfile=(gdb.parse_and_eval("zend_get_executed_filename")).dereference()
        self._phpfunc=(gdb.parse_and_eval("get_active_function_name")).dereference()
        self._phplineno=(gdb.parse_and_eval("zend_get_executed_lineno")).dereference()
    def _get_exec_info(self):
        filename=((str(self._phpfile())).partition(' '))[2]
        funcname=((str(self._phpfunc())).partition(' '))[2]
        lineno=int(self._phplineno())
        return (funcname,filename,lineno)

    def stop(self):
        print "%s in %s:%d" % (self._get_exec_info())
        return False

class _SetupAnalyzePhp5Executer(gdb.Command):
    """ setup php5 executer tracer """
    def __init__(self):
        super(_SetupAnalyzePhp5Executer, self).__init__('setupphp5executer',
                                                  gdb.COMMAND_OBSCURE)

    def invoke(self, arg, from_ttyp):
        gdb.execute("set pagination off")
        _Php5ExecuterHook("zend_vm_execute.h:356")

_SetupAnalyzePhp5Executer()
------php5.5-gdb.pyここまで-----------------
$ cat -n test4.php
     1	<?php
     2	function func_a() // 1
     3	{
     4		echo "func_a!\n";
     5	}
     6	function func_b()
     7	{
     8		echo "func_b!\n";
     9	}
    10	func_a();
    11	func_b();
    12	?>
$ gdb --args /usr/bin/php5 test4.php
...中略...
(gdb) source php5.5-gdb.py
(gdb) setupphp5executer 
Breakpoint 1 at 0x746d70: file /tmp/buildd/php5-5.5.0~rc3+dfsg/Zend/zend_vm_execute.h, line 356.
(gdb) run
...中略...
"main" in "/home/nojima/prog/my-works/php5-dbg/test4.php":2
"main" in "/home/nojima/prog/my-works/php5-dbg/test4.php":6
"main" in "/home/nojima/prog/my-works/php5-dbg/test4.php":10
"func_a" in "/home/nojima/prog/my-works/php5-dbg/test4.php":4
func_a!
"func_a" in "/home/nojima/prog/my-works/php5-dbg/test4.php":5
"main" in "/home/nojima/prog/my-works/php5-dbg/test4.php":11
"func_b" in "/home/nojima/prog/my-works/php5-dbg/test4.php":8
func_b!
"func_b" in "/home/nojima/prog/my-works/php5-dbg/test4.php":9
"main" in "/home/nojima/prog/my-works/php5-dbg/test4.php":13
(gdb)
\end{commandline}

簡易なものではありますが、無事、phpのソースレベルの実行トレースが取れています。

\subsection{おわりに}

 今回phpソースの実行トレースを取る例を使い、debianの元で
gdb+python拡張を使ったデバッグ手法について述べました。こちらを
応用すれば、phpソースレベルのブレークポイントを作るなど、
様々な応用ができます。

　gdb+python拡張のデバッグ能力はまだまだ沢山便利な機能が入ってます。
是非、debianパッケージのデバッグのお供にいかがでしょうか？

\begin{thebibliography}{0}

\bibitem{tokyo-debian-march}
第98回東京エリアDebian勉強会資料「gdb python拡張その1」,
\url{http://tokyodebian.alioth.debian.org/2013-03.html}

\bibitem{debug-debian-net}
2012年大統一Debian勉強会「debug.debian.net」,
\url{http://gum.debian.or.jp/2012/}

\bibitem{build-id-desc}
RolandMcGrath/BuildID,
\url{http://fedoraproject.org/wiki/RolandMcGrath/BuildID}
\end{thebibliography}

\end{document}
